{% extends 'base.html' %}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/agregar-producto.css') }}">
{% endblock %}

{% block content %}
    <div class="container">
        <h2>Agregar Producto</h2>
        {% if error %}
        <div class="error-message">{{ error }}</div>
        {% endif %}
        <form id="productForm" action="{{url_for('agregar_producto')}}" method="post" enctype="multipart/form-data">
            <label for="tipoProducto"> Tipo de producto(s):</label>
            <select class="tipoProducto" id="tipoProducto" name="tipoProducto">
                <option value="none">Ninguno</option>
                <option value="fruta">Fruta</option>
                <option value="verdura">Verdura</option>
            </select>
            <div id="contenedor"> 
            </div>

            <label for="descripcion">Descripción:</label>
            <textarea name="Descripcion" id="descripcion" cols="50" rows="4"></textarea>

            {% for i in range(1, 4) %}
            <label for="foto{{ i }}">Foto {{ i }}:</label>
            <div class="input-container">
                <input type="file" id="foto{{i}}" name="foto{{i}}" accept="image/*">
            </div> 
            {% endfor %}
        
            <label for="region">Región:</label>
            <select id="region" name="region">
                <option value="none">Seleccionar</option>
                {% for region in regiones %}
                    <option value="{{ region[0] }}">{{ region[1] }}</option>
                {% endfor %}
            </select>

            <label for="comuna">Comuna:</label>
            <select id="comuna" name="comuna">
                <option value="none">Seleccionar región</option>
            </select>

            <label for="nombreProductor">Nombre Productor:</label>
            <input type="text" id="nombreProductor" name="nombreProductor" minlength="3" maxlength="80" placeholder="Ej: Juan Pérez">

            <label for="emailProductor">Email Productor:</label>
            <input type="email" id="emailProductor" name="emailProductor" placeholder="Ej: tucorreo@dominio.com">

            <label for="celularProductor">Número celular Productor:</label>
            <input type="tel" id="celularProductor" name="celularProductor" placeholder="Formato: +569XXXXXXXX">

            <button type="button" id="agregarProducto">Agregar Producto(s)</button>
        </form>

        <div class="confirmation" id="confirmationMessage" style="display: none;">
            <p>¿Confirma el registro de este producto?</p>
            <button id="confirmar">Sí, confirmo</button>
            <button id="cancelar">No, quiero volver al formulario</button>
          </div>
    </div>
{% endblock %}
{% block javascript %}
    <script>
    //Listas de frutas y verduras
    const lista_frutas = {{frutas|tojson|safe}};
    const lista_verduras = {{verduras|tojson|safe}};

    //Creador de listas para frutas/verduras
    const crearLista = (tipoProducto, i) => {
    let lista = document.createElement("select");
    lista.name = "Producto" + (i + 1);
    lista.className = "productos";
    if (tipoProducto == "fruta") {
        for (let i = 0; i < lista_frutas.length; i++) {
            if (i == 0){
                let opcion = document.createElement("option");
                opcion.value = "none";
                opcion.text = "Seleccionar";
                lista.appendChild(opcion);
            }
            let fruta;
            if (typeof lista_frutas[i] === 'string') {
                const partes = lista_frutas[i].split(",");
                fruta = partes[1];
            } else {
                fruta = lista_frutas[i][1];
                id_fruta = lista_frutas[i][0];
            }
            const nuevoElemento = document.createElement("option");
            nuevoElemento.value = id_fruta;
            nuevoElemento.text = fruta;
            lista.appendChild(nuevoElemento);
        }
    } else if (tipoProducto == "verdura") {
        for (let i = 0; i < lista_verduras.length; i++) {
            if (i == 0){
                let opcion = document.createElement("option");
                opcion.value = "none";
                opcion.text = "Seleccionar";
                lista.appendChild(opcion);
            }
            let verdura;
            if (typeof lista_verduras[i] === 'string') {
                const partes = lista_verduras[i].split(",");
                verdura = partes[1];
            } else {
                verdura = lista_verduras[i][1];
                id_verdura = lista_verduras[i][0];
            }
            const nuevoElemento = document.createElement("option");
            nuevoElemento.value = id_verdura;
            nuevoElemento.text = verdura;
            lista.appendChild(nuevoElemento);
        }
    }
    return lista;
    };
    //EventListener para que cada vez que se seleccione un tipo de producto aparezca/desaparezca la lista respectiva.
    const tipoProductos = document.getElementById("tipoProducto");
    let tipoActual = tipoProductos.value;
    tipoProductos.addEventListener("change", () => {
            const contenedorId = 'contenedor' ;
            const contenedor = document.getElementById(contenedorId);
            while (contenedor.firstChild) {
                contenedor.removeChild(contenedor.firstChild);
            }
            if (tipoProductos.value == "none") {
                return;
            }
            for (let i = 0; i < 5; i++) {
                let label = document.createElement("label");
                label.textContent = `Producto ${i+1}`;
                contenedor.appendChild(label);
                let lista = crearLista(tipoProductos.value, i);
                contenedor.appendChild(lista);
            }
        });
    //Agregamos las regiones y comunas
    const dicc_comunas = {{ comunas|tojson|safe }};
    const selected_region = document.getElementById("region");
    const selected_comuna = document.getElementById("comuna");

    //EventListener para cambiar la lista de comunas según la región seleccionada
    selected_region.addEventListener("change", () => {
        while (selected_comuna.firstChild) {
            selected_comuna.removeChild(comuna.firstChild);
        }
        const selectedRegionId = selected_region.value;
        if(selectedRegionId == "none") {
            let opcion = document.createElement("option");
            opcion.value = "none";
            opcion.text = "Seleccionar";
            selected_comuna.appendChild(opcion);
            return;
        }
        const selectedRegionComunas = dicc_comunas[selectedRegionId];
        if (selectedRegionComunas) {
            selectedRegionComunas.forEach((n_comuna) => {
                let nuevaComuna = document.createElement("option");
                nuevaComuna.value = n_comuna[0];
                nuevaComuna.text = n_comuna[1];
                comuna.appendChild(nuevaComuna);
            });
        }
    });

</script>
<script src="{{ url_for('static', filename='js/agregar-producto.js') }}" defer></script>
{% endblock %}
